<!DOCTYPE html>
<html>
    <head>
        <title>Test table</title>
        <meta charset="utf-8">
        <style type="text/css">
            * {
                padding: 0;
                margin: 0;
            }

            #container {
                width: 500px;
                height: 30px;
                border: 1px solid green;
                margin: 100px auto;
            }

            .wrapper {
                height: 100%;
                cursor: text;
                font-family: Tahoma;
            }

            .input-area {
                border: 0 none;
                height: 100%;
                line-height: 30px;
                font-size: 20px;
                width: 100%;
                outline: none;
            }

            .address, .address-edit {
                display: inline-block;
                padding: 0 5px;
                color: #A0A0A0;
            }

            .address {
                cursor: default;
                margin: 1px 3px;
            }

            .address:hover {
                background: #E6EAF0;
            }

            .address b {
                color: #000;
                font-weight: normal;
            }

            .address-edit {
                width: 10px;
            }

            .address-select {
                background: #475D76;
                color: #fff;
            }

            .address-select b, .address-select span {
                color: #fff;
            }

            .error {
                color: red;
            }

            .semicolon {
                color: #A0A0A0;
            }
        </style>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    </head>
    <body>
        <div id="container">
            <div class="wrapper">
                <div class="address-edit">
                    <input type="text" class="input-area">
                </div>
            </div>
        </div>
        <script>
            function log() {
                console.log(arguments[0]);
            }

             $.fn.getCursorPosition = function() {
                var input = this.get(0);
                if (!input) return; // No (input) element found
                if ('selectionStart' in input) {
                    // Standard-compliant browsers
                    return input.selectionStart;
                } else if (document.selection) {
                    // IE
                    input.focus();
                    var sel = document.selection.createRange();
                    var selLen = document.selection.createRange().text.length;
                    sel.moveStart('character', -input.value.length);
                    return sel.text.length - selLen;
                }
            };

            /*
                1，输入分号、回车、鼠标点击输入区域外，完成输入
                2，双击已输入邮箱，进入编辑状态
                3，左右键控制输入邮箱位置
                4，当输入框无内容时，第一次按删除键，前面的已输入邮箱高亮，再按删除键，邮箱删除。
            */
            (function() {
                var container,
                    wrapper,
                    area,  //当前输入input
                    areaParent,  //input父节点
                    areaIsBlank, //input是否为空
                    perWidth = 16,  //每个字宽度
                    selectClass = 'address-select',
                    addressHTML = '<div class="address" data-address="$0">\
                                    <b>$1<span>$2</span></b>\
                                    <span class="semicolon">;</span>\
                                   </div>',
                    areaHTML = '<div class="address"><input type="text" class="input-area"></div>',
                    rholder = /\$(\d)/g,
                    remail = /^(\w+)(@\w+\.[a-zA-Z]+)$/;

                var init = function() {
                    container = $('#container');
                    wrapper = $('.wrapper');
                    area = $('.address-edit .input-area');
                    areaParent = area.parent();
                    area.data('last-value', '');
                    hasChange = false,
                    isLeft = true,  //光标是否在input最左边
                    isRight = true; //光标是否在input最右边

                    bindEvent();
                };

                var bindEvent = function() {
                    area.on('keyup', function(e) {
                        var code = e.which;
                        //log(code);
                        codeCommand[code] && codeCommand[code](e);
                    })
                    .on('input propertychange', function() {
                        var last = area.data('last-value'),
                            latest = area.val();
                        var isBlank = (!last && !latest) ? true : false;
                        var cursorPosition = area.getCursorPosition();

                        isLeft = cursorPosition == 0;
                        isRight = cursorPosition == latest.length;

                        area.data('last-value', latest);
                        hasChange = true;
                        latest = latest || ' ';
                        areaParent.css('width', latest.length * perWidth);
                        //areaIsBlank = $.trim(this.value) ? false : true;
                    })
                    .on('focus', function() {
                        addressUtil.unselect();
                    })
                    .on('blur', function(e) {
                        var val = area.val();
                        if(addressUtil.isValid(val)) {
                            addressUtil.create(val);
                        }
                    });

                    wrapper.on('click',function(e) {
                        area.focus();
                    }).on('dblclick', '*', function(e) {
                        var target = $(e.currentTarget);
                        if(target.parent().hasClass('address')) {
                            target = target.parent();
                        }
                        if(target.hasClass('address')) {
                            addressUtil.edit(target);
                            e.stopPropagation();
                        }
                    });
                };

                var codeCommand = {
                    8: function(e) {  //删除
                        addressUtil.delete();
                    },

                    46: function(e) {  //Delete键

                    },

                    13: function() {  //回车
                        var val = $.trim(area.val()).split(';').join('');
                        val && addressUtil.create(val);
                    },

                    37: function() {  //左箭头
                        if(isLeft && areaParent.prev()[0]) {
                            addressUtil.forward();
                        } else {
                            isLeft = area.getCursorPosition() == 0;
                        }
                    },

                    39: function() {  //右箭头
                        if(isRight && areaParent.next()[0]) {
                            addressUtil.back();
                        } else {
                            isRight = area.getCursorPosition() == area.val().length;
                        }
                    }
                };

                codeCommand[186] = codeCommand[13]; //回车与分号逻辑相同

                //按键操作
                var addressUtil = {
                    addresses: {},

                    isValid: function(address) {
                        return remail.test(address);
                    },

                    //邮件地址是否已存在
                    isExist: function(address) {
                        return this.addresses[address];
                    },

                    //取消地址的选中状态
                    unselect: function() {
                        var select = wrapper.find('.address-select');
                        if(select.length > 0) {
                            select.removeClass('address-select');
                        }
                    },

                    create: function(content) {
                        if(this.isExist(content)) {
                            log('already exist!');
                            return false;
                        }
                        var o = {};
                        var matches = content.match(remail);
                        if(matches) {
                            var html = addressHTML.replace(rholder, function(a, b) {
                                return matches[b];
                            });
                            var el = $(html);
                            area.val('');
                            el.insertBefore(areaParent);
                            this.addresses[content] = true;
                            this.reset(); //清理工作
                        }
                    },

                    edit: function(target) {
                        var address = target.data('address');
                        area.val(address);
                        areaParent.css('width', address.length * perWidth);
                        target.replaceWith(areaParent);
                        area.focus();
                        delete this.addresses[address];
                    },

                    delete: function() {
                        if(!hasChange) {
                            isLeft = true;
                        }
                        if(isLeft) {
                            var select = wrapper.find('.' + selectClass);
                            if(select[0]) {
                                delete this.addresses[select.data('address')];
                                this.reset();
                                return select.remove();
                            }
                            addressUtil.selectBefore();
                        }
                        hasChange = false;
                    },

                    forward: function() {
                        areaParent.insertBefore(areaParent.prev());
                        area.focus();
                        addressUtil.unselect();
                    },

                    back: function() {
                        areaParent.insertAfter(areaParent.next());
                        area.focus();
                        addressUtil.unselect();
                    },

                    select: function(el) {
                        el.addClass(selectClass);
                    },

                    selectBefore: function() {
                        this.select(areaParent.prev());
                    },

                    selectAfter: function() {
                        this.select(areaParent.after());
                    },

                    reset: function() {
                        isLeft = true;
                        isRight = true;
                        hasChange = false;
                        areaParent.css('width', 10);
                        area.focus();
                    }
                };

                init();
            })();
        </script>
    </body>
</html>